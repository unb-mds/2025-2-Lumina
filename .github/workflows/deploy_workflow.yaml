name: Deploy FastAPI to Oracle Cloud

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  deploy:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Oracle Cloud Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "üöÄ Iniciando deploy do Lumina Backend..."

            ###############################################
            # 1. Criar diret√≥rio tempor√°rio
            ###############################################
            TEMP_DIR=$(mktemp -d)

            echo "üì• Clonando reposit√≥rio..."
            git clone --depth 1 https://github.com/unb-mds/2025-2-Lumina.git "$TEMP_DIR"

            ###############################################
            # 2. Fazer backup do .env (se existir)
            ###############################################
            if [ -f "lumina-backend/backend/.env" ]; then
                echo "üõü Fazendo backup do .env..."
                cp lumina-backend/backend/.env lumina-backend/backend/.env.backup
            else
                echo "‚ö†Ô∏è Nenhum .env encontrado para backup."
            fi

            ###############################################
            # 3. Copiar backend atualizado
            ###############################################
            echo "üì¶ Copiando arquivos do backend..."

            rsync -av \
                --exclude='.env' \
                --exclude='venv' \
                --exclude='__pycache__' \
                --exclude='app/db/chroma_db' \
                "$TEMP_DIR/backend/" \
                lumina-backend/backend/

            rm -rf "$TEMP_DIR"

            ###############################################
            # 4. Instalar / atualizar depend√™ncias
            ###############################################
            echo "üì¶ Instalando depend√™ncias..."

            cd lumina-backend/backend || exit 1

            venv/bin/pip install -r requirements.txt --no-cache-dir

            ###############################################
            # 5. Ajustar permiss√µes
            ###############################################
            echo "üîê Ajustando permiss√µes..."
            sudo chown -R ***:*** /home/***/lumina-backend/backend

            ###############################################
            # 6. Reiniciar servi√ßo systemda
            ###############################################
            echo "üîÑ Reiniciando servi√ßo..."
            sudo systemctl restart luminabackend.service

            echo "‚è≥ Aguardando servi√ßo iniciar..."
            sleep 5

            ###############################################
            # 7. Verificar status do servi√ßo
            ###############################################
            echo "‚úÖ Status do servi√ßo:"
            sudo systemctl status luminabackend.service --no-pager

            ###############################################
            # 8. Testar API
            ###############################################
            echo "üß™ Testando API..."
            if curl -f http://localhost/; then
                echo "‚ú® Deploy conclu√≠do com sucesso!"
            else
                echo "‚ùå ERRO: API n√£o respondeu corretamente!"
                exit 1
            fi

      - name: Notify deployment success
        if: success()
        run: |
          echo "‚úÖ Deploy realizado com sucesso em http://152.67.59.120"
          echo "üïê Hor√°rio: $(date)"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "‚ùå Falha no deploy - verifique os logs"
          exit 1
